<!doctype html>
<html>
  <head>
    <title>Munchkin</title>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="/style.css"/>
  </head>
  <body>
    <div id="sidebar">
      <div id="chatbox">
        <h4>Chat</h4>
        <ul id="messages"></ul>
        <div id="typing"></div>
        <ul id="online"></ul>
        <form action="" id="chatForm">
          <input id="m" autocomplete="off" />
        </form>
      </div>
      <div id="historybox">
        <h4>History</h4>
        <ul id="history"></ul>
      </div>

      <div class="optionMenu" id="options">
        <div id="clientOptionsBox">
          <h4 id="clientOptions1" onClick="(function(){$('#clientOptions').toggle();if($('#clientOptions1').text()[-2] == '-'){$('#clientOptions1').text('Client Options [+]');} else {$('#clientOptions1').text('Client Options [-]');}})()">Client Options [-]</h4>
          <ul id="clientOptions">
<!--             <li>
              <ul id="kickMenu">
                <li>Kick Player
                  <ul>
                    <li>Players
                      <ul class="playerMenu"><ul></ul></ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>Add Player</li>
            <li id="enableVassal" onClick="enableVassal()">Enable Vassal</li>
            <li id="disableVassal" onClick="disableVassal()">Enable Vassal</li> -->
          </ul>
        </div>

        <div class="optionMenu" id="staticOptionsBox">
          <h4>Game Options</h4>
          <ul id="staticOptions">
            <li onClick="socket.emit('kick')">Kick</li>
            <li onClick="socket.emit('loot')">Loot the Room</li>
            <li onClick="lookForTrouble()">Look for Trouble</li>
<!--             <li onClick="charityDialog()">Charity</li> -->
            <li>
              <ul id="drawMenu">
                <li>Draw
                  <ul>
                    <li>Door
                      <ul>
                        <li onClick="socket.emit('draw', 'doors')">Normal</li>
                        <li onClick="socket.emit('toggle deck', 'door')">Choice (toggle)</li>
                      </ul>
                    </li>
                    <li>Treasure
                      <ul>
                        <li onClick="socket.emit('draw', 'treas')">Normal</li>
                        <li onClick="socket.emit('toggle deck', 'treas')">Choice (toggle)</li>
                      </ul>
                    </li>
                    <li>Door Discard
                      <ul>
                        <li onClick="socket.emit('draw', 'dDis')">Normal</li>
                        <li onClick="socket.emit('toggle deck', 'dDis')">Choice (toggle)</li>
                      </ul>
                    </li>
                    <li>Treasure Discard
                      <ul>
                        <li onClick="socket.emit('draw', 'tDis')">Normal</li>
                        <li onClick="socket.emit('toggle deck', 'tDis')">Choice (toggle)</li>
                      </ul>
                    </li>
                    <li>Players
                      <ul class="playerMenu"></ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <ul id="curseMenu">
                <li>Curse
                  <ul>
                    <li>Players
                      <ul id="curseMenuPlayers"></ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li onClick="moveCard('discard')">Discard</li>
            <li onClick="socket.emit('end turn')">End Turn</li>
            <!-- <li>  
              <ul id="tradeMenu">
                <li>Trade
                  <ul>
                    <li>Players
                      <ul class="playerMenu"></ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li onClick="sellDialog()">Sell</li>
            <li onClick="shareDialog()">Treasure Share</li> -->
          </ul>
        </div>

        <div class="optionMenu" id="dynamicOptionsBox">
          <h4 id="miscOptions" onClick="(function(){$('#dynamicOptions').toggle();if($('#miscOptions').text()[-2] == '-'){$('#miscOptions').text('Misc Options [+]');} else {$('#miscOptions').text('Misc Options [-]');}})()">Misc Options [-]</h4>
          <ul id="dynamicOptions">
            <li>  
              <ul id="moveMenu">
                <li>Move Cards
                  <ul>
                    <li onClick="moveCard(username + ' field')">Field</li>
                    <li onClick="moveCard(username + ' hand')">Hand</li>
                    <li onClick="moveCard('field')">Game Field</li>
                    <li onClick="moveCard('doors')">Doors</li>
                    <li onClick="moveCard('treas')">Treasures</li>
                    <li>Players<ul id="moveMenuPlayers"></ul></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li onClick="randomVal()">Get Roll</li>
<!--             <li onClick="socket.emit('resurrect')">Resurrect</li> -->
            <!-- <li onClick="runDialog()">Run Away</li> -->
<!--             <li onClick="startCombat()">Start Combat</li>
            <li onClick="endCombat()">End Combat</li> -->
            <li onClick="socket.emit('toggle hand')">Toggle Hand</li>
            <li onClick="socket.emit('change gender')">Change Gender</li>
            <li><a target="_blank" href="http://www.worldofmunchkin.com/rules/munchkin_rules.pdf"/>Rules</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div id="fields">
      <div id="infobar">
        <h4>Munchkin</h4>
        <ul id="turnInfo">
          <li>
            <ul id="turnPlayerInfo">
              <li>Turn Player: <span id="turnPlayer"></span></li>
            </ul>
          </li>
          <li>
            <ul id="monsterInfo">
              <li><button id="addMonStr" onClick="socket.emit('monster strength', 1)">+</button></li>
              <li>Monster Strength: <span id="monsterStr">0</span></li>
              <li><button id="lowerMonStr" onClick="socket.emit('monster strength', -1)">-</button></li>
            </ul>
          </li>
          <li>
            <ul id="playerInfo">
              <li>You (<span id="user"></span>, <span id="gender"></span>): </li>
              <li><button id="addStrength" onClick="strength(1)">+</button></li>
              <li>Strength: <span id="strength">1</span></li>
              <li><button id="lowerStrength" onClick="strength(-1)">-</button></li>
              <li><button id="addLevel" onClick="level(1)">+</button></li>
              <li>Level: <span id="level">1</span></li>
              <li><button id="lowerLevel" onClick="level(-1)">-</button></li>
            </ul>
          </li>
          <li>
            <ul>
              <li>Random Val: <span id="randomVal"></span></li>
            </ul>
          </li>
        </ul>
      </div>

      <div class="gameDiv" id="game">
        <div id="doors"><img src="/images/door_back.gif"/></div>
        <div id="dDis"></div>
        <div class="field" id="gameFieldCards"></div>
        <div id="tDis"></div>
        <div id="treasures"><img src="/images/treasure_back.gif"/></div>
      </div>

      <div class="gameDiv" id="doorCardDiv">
        <div class="field" id="doorFieldCards"></div>
      </div>

      <div class="gameDiv" id="treasCardDiv">
        <div class="field" id="treasureFieldCards"></div>
      </div>

      <div class="gameDiv" id="dDisCardDiv">
        <div class="field" id="dDisFieldCards"></div>
      </div>

      <div class="gameDiv" id="tDisCardDiv">
        <div class="field" id="tDisFieldCards"></div>
      </div>

      <div class="gameDiv" id="otherPlayers">
        <div class="handField" id="otherHandField"></div>
      </div>

      <div class="gameDiv" id="player">
        <div class="handField" id="handField">
          <ul><div onClick="(function() {$('#cardFieldCards').hide();$('#cardHandCards').show();})()">Hand</div></ul> 
          <ul><div onClick="(function() {$('#cardHandCards').hide();$('#cardFieldCards').show();})()">Field</div></ul>
        </div>
        <div class="field" id="cardHandCards"></div>
        <div class="field" id="cardFieldCards"></div>
      </div>
    </div>
    <div id="imageContainer"></div>
    <div id="loadScreen">
      <h1>Loaded Players</h1>
      <div id="loadedPlayers"></div>
      <h3>Waiting for <span id="numPlayers">3</span> more players...</h3>
    </div>
    <script src="game_objects1.js"></script>
    <script src="munchCardNames.js"></script>
    <script>
      var socket = io.connect();
      var game = new Game();
      var spectate = false;
      var username = '';
      var gender = '';
      var numPlayers = 0;
      var otherPlayersFocus = '';
      var selectedCards = [];
      var chatAudio = document.createElement('audio');
      chatAudio.setAttribute('src', 'DING.wav');

      $('#fields').hide();
      $('#loadScreen').show();
      $('#options').hide();
      
      function toggleSelect(card) {
        var index = selectedCards.indexOf(card);
        if (card.indexOf('+') !== -1) {
          card = card.replace('+', '\\+')
        }
        if (index !== -1) {
          selectedCards.splice(index, 1);
          $('#' + card).toggleClass('selected');
        } else {
          selectedCards.push(card);
          $('#' + card).toggleClass('selected');
        }
      }

      function togglePlayerField(name, field) {
        $(otherPlayersFocus).toggle();
        otherPlayersFocus = '#' + name + field + 'Cards';
        $(otherPlayersFocus).toggle();
      }

      function moveCard(deck) {
        if (selectedCards == []) {
          return;
        }
        var cardNames = getSelected().slice();
        for (var cardName of cardNames) {
          toggleSelect(cardName);
        }
        socket.emit('move cards', deck, cardNames);
      }

      function lookForTrouble() {
        if (selectedCards == []) {
          return;
        }
        var monsterName = getSelected()[0];
        for (var cardName of getSelected()) {
          toggleSelect(cardName);
        }
        socket.emit('look', monsterName);
      }

      function loadCards(playerName, field, cards) {
        for (var cardName of cards) {
          if (cardName.indexOf('+') !== -1) {
            cardName = cardName.replace('+', '\\+');
          }
          $('#' + cardName).appendTo($('#' + playerName + field + 'Cards'));
        }
      }

      // init card images
      $('#imageContainer').hide();
      for (var cardName of munchNames) {
        var name = cardName.substring(0, cardName.length - 4);
        $('#imageContainer').append('<img class="card" id="' + name + '" src="/images/' + cardName + '"/>');
      }

      $('#doors').on('mousedown', function(e) {
        if (e.which == 1) {
          socket.emit('draw', 'doors');
        }
        if (e.which == 3) {
          socket.emit('face up', 'doors');
        }
      });

      $('#treasures').on('mousedown', function(e) {
        if (e.which == 1) {
          socket.emit('draw', 'treas');
        }
        if (e.which == 3) {
          socket.emit('face up', 'treas');
        }
      });

      socket.on('toggle equip', function (name, isEquipped) {
        var card  = game.findCards([name]);
        if(name.indexOf('+') !== -1) {
          name = name.replace('+', '\\+');
        }
        $('#' + name).toggleClass('unequipped');
        card.isEquipped = isEquipped;
      });

      $('.card').on('mousedown', function(e) {
        if (e.which === 1) {
          toggleSelect($(this).attr('id'));
        }
        if (e.which === 3) {
          socket.emit('toggle equip', $(this).attr('id'));
        } 
      });

      $('.card').on('contextmenu', function(evt) {
        evt.preventDefault();
      });

      $('#game').on('contextmenu', function(evt) {
        evt.preventDefault();
      });
    </script>
    <script src="chat.js"></script>
    <script> // init socket functions
      socket.on('connect', function(){
        while (username == '' || username == null) {
          username = prompt('Choose a nickname.');
        }
        while (gender !== 'male' && gender !== 'female') {
          gender = prompt('What gender would you like to have (male/female)?');
        }
        $('#user').text(username);
        $('#gender').text(gender);
        socket.emit('new user', username, gender);
        myMessage('You have connected to the server. You may start sending messages...');
      });

      socket.on('username', function() {
      	username = prompt('Username taken. Choose another.');
      	$('#user').text(username);
      	socket.emit('new user', username, gender);
      })

      socket.on('spectate', function() {
      	$('#messages').append($('<li>').text('Sorry, the game is full. You may continue sending messages or ask to be added to the game.'));
      	spectate = true;
      	$('#player').hide();
        $('#options').hide();
        $('#loadScreen').hide();
        $('#fields').show();
        $('#playerInfo').hide();
        $('#monsterInfo button').hide();
        $('#doors').hide();
        $('#treasures').hide();
        socket.emit('spectate');
      });

      socket.on('unspectate', function(player) {
        spectate = false;
        $('#' + player + 'FieldCards img').appendTo('#cardField');
        $('#' + player + 'Field').remove();
        $('#' + player + 'FieldCards').remove();
        var newSelf = game.players.get('player');
        //setup username/gender
        //redo player menus
        var cards = [];
        for (var card of newSelf.hand.keys()) {
          cards.push(card);
        }
        loadCards('card', 'Hand', cards);
        $('#player').show();
        $('#option').show();
        // finish
      });

      socket.on('players', function() {
      	while(numPlayers < 3 || numPlayers > 6) {
      		numPlayers = prompt('How many players should there be (3-6)?');      		
      	}
      	socket.emit('players', numPlayers);
      });

      socket.on('online update', function(online, numPlayers) {
        $('#loadedPlayers').html('');
        for (var user in online) {
          var name = online[user].name;
          var gender = online[user].gender;
          $('#loadedPlayers').append('<div class="loadBar"><img src="/images/' + gender + '.gif"/><span>' + name + ' ' + gender + '</span></div>');
        }
        $('#numPlayers').text(numPlayers - online.length);
      });

    	socket.on('game', function(initCards, init) {
        for (var player of initCards.players) {
          var name = player[0].name;
          if (name != username) {
            if (init) {
              $('#otherPlayers').append('<div class="field" id="' + name + 'FieldCards"></div>');
              $('#otherPlayers').append('<div class="field" id="' + name + 'HandCards"></div>');
              $('.playerMenu').append('<li>' + name + '</li>');
              $('#moveMenuPlayers').append('<li onClick="moveCard(\'' + name + ' hand\')">' + name + '</li>');
              $('#curseMenuPlayers').append('<li onClick="moveCard(\'' + name + ' field\')">' + name + '</li>');
              $('#otherHandField').append('<ul><div id="' + name + 'Field" onClick="togglePlayerField(\'' + name + '\', \'Field\')">' + name + ' Level: <span class="' + name + 'Level">1</span> Strength: <span class="' + name + 'Strength">1</span> Gender: <span class="' + name + 'Gender">' + player[0].gender + '</span></div></ul>');  
            }
            game.addPlayer(player[0], player[1], player[2]);
            var newPlayer = game.players.get(name);
            loadCards(name, 'Hand', player[1]);
            loadCards(name, 'Field', player[2]);
            $('#' + name + 'HandCards').hide();
            $('#' + name + 'FieldCards').hide();
            togglePlayerField(name, 'Field');
          } else {
            if (!spectate) {
              game.addPlayer(player[0], player[1], player[2]);
              loadCards('card', 'Hand', player[1]);
              loadCards('card', 'Field', player[2]);
              $('#cardFieldCards').hide();
            }
          }
        }

        var doorCards = [];
        for (var card of game.findCards(initCards.doors).values()) {
          card.setCard1(game.doors);
          doorCards.push(card.name);
        }
        loadCards('door', 'Field', doorCards);

        var treasCards = [];
        for (var card of game.findCards(initCards.treas).values()) {
          card.setCard1(game.treas);
          treasCards.push(name);
        }
        loadCards('treasure', 'Field', treasCards);

        $('#doorCardDiv').hide();
        $('#treasCardDiv').hide();
        $('#dDisCardDiv').hide();
        $('#tDisCardDiv').hide();

        // fix menus, add functionality incl toggle
        // initiate user menus
        if (init) {
          $('#turnPlayer').text(game.players.keys().next().value);
          var num = initCards.players.length - 1;
          var newHeight = ((280 - 10 * num) / num);
          $('#otherHandField div').height(newHeight);
          $('#drawMenu').menu();
          $('#moveMenu').menu();
          $('#curseMenu').menu();
          $('#tradeMenu').menu();
          $('#kickMenu').menu();
        }

        if (!spectate) {
          $('#loadScreen').hide();
          $('#fields').show();
          $('#options').show();
        }
    	});
    </script>
    <script src="client.js"></script>
  </body>
</html>